<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Control Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #fff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #4caf50; }
        .error { background-color: #f44336; }
        .warning { background-color: #ff9800; }
        .info { background-color: #2196f3; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #666; cursor: not-allowed; }
        #output {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            background-color: #2d2d2d;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Voice Control Diagnostic Tool</h1>
    
    <div id="browser-check"></div>
    <div id="mic-check"></div>
    <div id="backend-check"></div>
    
    <h2>Speech Recognition Test</h2>
    <button id="start-btn">Start Listening</button>
    <button id="stop-btn" disabled>Stop Listening</button>
    <button id="test-cmd-btn">Test Voice Command</button>
    
    <h3>Status:</h3>
    <div id="status" class="status info">Ready</div>
    
    <h3>Last Command:</h3>
    <div id="last-command">None</div>
    
    <h3>Output Log:</h3>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const lastCommand = document.getElementById('last-command');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const testCmdBtn = document.getElementById('test-cmd-btn');
        
        let recognition = null;
        let isListening = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `[${timestamp}] ${message}`;
            div.className = type;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Check browser compatibility
        function checkBrowser() {
            const browserCheck = document.getElementById('browser-check');
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                browserCheck.innerHTML = '<div class="status success">✓ Browser supports speech recognition</div>';
                log('Browser supports speech recognition', 'success');
                return true;
            } else {
                browserCheck.innerHTML = '<div class="status error">✗ Browser does not support speech recognition. Please use Chrome or Edge.</div>';
                log('Browser does not support speech recognition', 'error');
                return false;
            }
        }

        // Check microphone permissions
        async function checkMicrophone() {
            const micCheck = document.getElementById('mic-check');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                micCheck.innerHTML = '<div class="status success">✓ Microphone access granted</div>';
                log('Microphone access granted', 'success');
                return true;
            } catch (error) {
                micCheck.innerHTML = `<div class="status error">✗ Microphone access denied: ${error.message}</div>`;
                log(`Microphone access denied: ${error.message}`, 'error');
                return false;
            }
        }

        // Check backend connection
        async function checkBackend() {
            const backendCheck = document.getElementById('backend-check');
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    const data = await response.json();
                    backendCheck.innerHTML = '<div class="status success">✓ Backend connection successful</div>';
                    log(`Backend connected: ${data.status}`, 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                backendCheck.innerHTML = `<div class="status error">✗ Backend connection failed: ${error.message}</div>`;
                log(`Backend connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return false;
            }

            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                updateStatus('Listening...', 'success');
                log('Speech recognition started', 'success');
                startBtn.disabled = true;
                stopBtn.disabled = false;
                isListening = true;
            };
            
            recognition.onresult = (event) => {
                const command = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                lastCommand.textContent = command;
                log(`Command heard: "${command}"`, 'success');
                processCommand(command);
            };
            
            recognition.onerror = (event) => {
                updateStatus(`Error: ${event.error}`, 'error');
                log(`Speech recognition error: ${event.error}`, 'error');
                if (event.error === 'not-allowed') {
                    log('Please grant microphone permission and refresh the page', 'warning');
                }
            };
            
            recognition.onend = () => {
                updateStatus('Stopped', 'warning');
                log('Speech recognition ended', 'warning');
                startBtn.disabled = false;
                stopBtn.disabled = true;
                isListening = false;
            };

            return true;
        }

        // Process voice commands
        async function processCommand(command) {
            log(`Processing command: "${command}"`, 'info');
            
            try {
                const response = await fetch('http://localhost:8000/commands/execute-voice-command/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `command=${encodeURIComponent(command)}`
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Command executed: ${result.message}`, 'success');
                } else {
                    const error = await response.text();
                    log(`Command failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`Command execution error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    log(`Failed to start recognition: ${error.message}`, 'error');
                }
            }
        });

        stopBtn.addEventListener('click', () => {
            if (recognition && isListening) {
                recognition.stop();
            }
        });

        testCmdBtn.addEventListener('click', async () => {
            await processCommand('help');
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            log('Starting diagnostic checks...', 'info');
            
            const browserOk = checkBrowser();
            const micOk = await checkMicrophone();
            const backendOk = await checkBackend();
            
            if (browserOk && micOk) {
                if (initSpeechRecognition()) {
                    log('Speech recognition initialized successfully', 'success');
                    updateStatus('Ready to listen', 'success');
                } else {
                    log('Failed to initialize speech recognition', 'error');
                    updateStatus('Initialization failed', 'error');
                }
            } else {
                log('Prerequisites not met for voice control', 'error');
                updateStatus('Prerequisites not met', 'error');
                startBtn.disabled = true;
            }
        });
    </script>
</body>
</html>